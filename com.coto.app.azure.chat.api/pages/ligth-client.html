<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            background-color: #9999ff;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <label>Cliente </label>  <input type="text" id="customer" value="26363216" />
        <label>Canal</label><input type="text" id="channel" value="COTO Digital" />
        <input type="hidden" id="channelId" value="BCEDC838-A6EB-4154-B8E0-8CEE6991F0C5" />
        <label>Usuario</label><input type="text" id="user" />
        <input type="button" id="connect" value="conectar" />
    </div>
    <div class="container">
        <ul id="casesUl"></ul>
    </div>
    <div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <!--<input type="button" id="sendimage" value="Send img" />-->
        <ul id="discussion"></ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="http://localhost:50014/Scripts/jquery.signalR-2.3.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:50014/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">

        var SubscriptionId = '';

        $(function () {

            var oldMessages = Array();
            // Declare a proxy to reference the hub.
            $.connection.hub.url = "http://localhost:50014/signalr";
            var chat = $.connection.chatHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message) {
                //console.log(message);
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();

                if (message.Type === 'text') {
                    if ($.inArray(message.Id, oldMessages) == -1) {
                        oldMessages.push(message.Id);
                        //este es el mensaje
                        var encodedMsg = $('<div />').text(message.Text).html();
                        // Add the message to the page.
                        $('#discussion').append('<li><strong>' + encodedName
                            + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
                    }
                }
                else if (message.Type === 'case') {
                    $('#casesUl').append('<li><strong>Caso</strong>:&nbsp;&nbsp;<small data-id="' + message.RefId + '">' + message.Ref + '</small></li>');
                }
                else {
                    var encodedMsg = '<div><img src="' + message.ImageHeaders + message.ImageBinary + '" ></div>';
                    //este es el mensaje
                    //var encodedMsg = $('<div />').text(message).html();
                    // Add the message to the page.

                    $('#discussion').append('<li><strong>' + encodedName
                        + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
                }
                //$('#discussion').append(image);
            };
            // Get the user name and store it to prepend to messages.
            $('#displayname').val('pepe');//prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {

                //chat.server.registerClient($('#displayname').val(), 'BCEDC838-A6EB-4154-B8E0-8CEE6991F0C5');
                $('#connect').click(function () {
                    chat.server.register($('#customer').val(), 'BCEDC838-A6EB-4154-B8E0-8CEE6991F0C5', $('#user').val())
                });

                //chat.server.joinRoom('otro');

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#user').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });

                $('#sendimage').click(function () {
                    chat.server.sendImage($('#displayname').val(), $('#message').val());
                });

                $(document).on('touch click', 'small', function (e) {
                    console.log($(this).data('id'));
                    chat.server.subscribe($(this).data('id'));
                });

            })
                .fail(function (err) { console.log('Could not connect' + err); });
        });

    </script>
</body>
</html>