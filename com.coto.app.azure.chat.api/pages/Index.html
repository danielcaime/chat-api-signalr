<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Back office</title>
    <style type="text/css">
        .container {
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }

        .b {
            background-color: #9999ff;
        }

        .r {
            background-color: #ff6a00;
        }

        .e {
            background-color: #0094ff;
        }

        .f {
            background-color: #ffd800;
        }
    </style>
</head>
<body>
    <div class="container b">
        <ol id="channelsUl"></ol>
    </div>
    <div class="container e">
        <ol id="casesUl"></ol>
    </div>
    <div class="container" id="dvchats">

    </div>
    <!--Reference the jQuery library. -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="http://localhost:50014/Scripts/jquery.signalR-2.3.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:50014/signalr/hubs"></script>

    <script>
        ; (function () {

            'use strict';
            //channels
            var channels = Array();
            var channel = {};
            channel.Id = 'BCEDC838-A6EB-4154-B8E0-8CEE6991F0C5';
            channel.Code = 'COTODIGITAL';
            channel.Name = 'COTO Digital';
            channels.push(channel);
            $.each(channels, function (i, val) {
                $('#channelsUl').append('<li><strong>Canal</strong>:&nbsp;&nbsp;<small data-id="' + val.Id + '">' + val.Name + '</small></li>');
            });
            //end channels
            var SubscriptionId = '';
            var UserId = '14571A3C-92D1-44F0-B192-C33B8F78B1F3';
            var oldMessages = Array();

            $.connection.hub.url = "http://localhost:50014/signalr";
            var chat = $.connection.chatHub;

            $.connection.hub.start().done(function () {
            })
                .fail(function (err) { console.log('Could not connect' + err); });
            //
            var getChannels = () => {
                $('input[name=send]').click(function () {
                    var message = {};
                    message.Type = "text";
                    message.Title = $('input[name=message]').val();
                    message.Text = $('input[name=message]').val();
                    message.SendTo = $('input[name=sendto]').val();
                    message.SendFrom = $('input[name=name]').val();
                });
            }

            var getSubscriptions = () => {

                let linkUserSubscriptionPost = {
                    UserId: UserId, //'14571A3C-92D1-44F0-B192-C33B8F78B1F3',
                    LinkChannelCode: 'COTODIGITAL',
                    UserProfileCode: 'CDIGI-ENV-CADETE'
                }

                var api = 'https://cotoapp-lab-appservice.azurewebsites.net/api/LinkUserSubscription';
                var apiDesa = 'http://localhost:62888/api/LinkUserSubscription';

                $.ajax({
                    url: api,
                    method: "POST",
                    data: linkUserSubscriptionPost,
                    success: function (response) {
                        console.log(response);
                        SubscriptionId = response.SubscriptionId;
                        getCases(response.SubscriptionId, fillData)
                    },
                    error: function (request, status, errorThrown) {
                        console.log(request)
                    }
                });
            }

            var getCases = (subsId, callback, refId = '') => {

                var api = 'https://cotoapp-lab-appservice.azurewebsites.net/api/LinkCaseQry';
                var apiDesa = 'http://localhost:62888/api/LinkCaseQry';

                let lcqf = {
                    SubscriptionId: subsId,
                    FromDate: '01/01/2018',
                    RefId: refId,
                    CustomerId: '26363216',
                }

                $.ajax({
                    url: api,
                    method: "POST",
                    data: lcqf,
                    success: function (response) {
                        console.log(response);
                        callback(response.Data)
                    },
                    error: function (request, status, errorThrown) {
                        console.log(request)
                    }
                });
            }

            var fillData = (list, type = '#casesUl') => {
                $.each(list, function (i, val) {
                    $(type).append('<li><strong>Caso</strong>:&nbsp;&nbsp;<small data-id="' + val.RefId + '">' + val.Ref + '</small></li>');
                });
            }

            var addChatBox = (desc) => {
                $('#dvchats').append('<div class="container r">chat -' + desc + '- <input type= "text" id= "message" /><input type="button" id="sendmessage" value="Send" />  <ul id="chatUl"></ul></div><div class="container f">data -' + desc + '- <ul id="mdata"></ul> </div > ');
            }

            $(document).on('touch click', 'small', function (e) {
                console.log($(this).data('id'));
                console.log($(this).text());
                addChatBox($(this).text());
                chat.server.userRegister(UserId, channel.Id, 'Juan', SubscriptionId, $(this).data('id'));
                getCases(SubscriptionId, fillMessages, $(this).data('id'))
            });

            $(document).on('click', '#sendmessage', function (e) {
                // Call the Send method on the hub.
                chat.server.send('COTODIGITAL', $('#message').val());
                // Clear text box and reset focus for next comment.
                $('#message').val('').focus();
            });

            var fillMessages = (list) => {
                //console.log(list[0].LinkCaseMetadatas);

                //$.each(list[0].LinkCaseMessagesData, function (i, val) {
                //    $('#chatUl').append('<li><strong>' + val.AvatarName+'</strong>:&nbsp;&nbsp;<small data-id="' + val.RefId + '">' + val.Message + '</small></li>');
                //});

                $.each(list[0].LinkCaseMetadatas, function (i, obj) {
                    $('#mdata').append('<li><strong>' + obj.Name + '</strong>:&nbsp;&nbsp;<small data-id="' + obj.Id + '">' + obj.Value + '</small></li>');
                });
            }

            chat.client.broadcastMessage = function (name, message) {
                //console.log(message)
                if ($.inArray(message.Id, oldMessages) == -1) {
                    oldMessages.push(message.Id);
                    $('#chatUl').append('<li><strong>' + name + '</strong>:&nbsp;&nbsp;<small data-id="' + message.Id + '">' + message.Text + '</small></li>');
                }

                //fillMessages(message)
            }

            $(function () {
                getChannels();
                getSubscriptions();
            });
        }());
    </script>
</body>
</html>